// Prisma Schema for Settlr
// Database: PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")  // Used for migrations (bypasses PgBouncer)
}


// ============================================
// User & Authentication
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  avatarUrl String?
  preferredCurrency String @default("INR")
  
  // Pseudo-user support
  isPseudo    Boolean  @default(false)  // True for placeholder users
  createdById String?                    // Who created this pseudo-user
  createdBy   User?    @relation("CreatedUsers", fields: [createdById], references: [id])
  createdUsers User[]  @relation("CreatedUsers")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  memberships   GroupMember[]
  paidExpenses  Expense[]      @relation("ExpensePayer")
  expensePayments ExpensePayer[]
  expenseShares ExpenseShare[]
  settlements   Settlement[]   @relation("SettlementPayer")
  received      Settlement[]   @relation("SettlementReceiver")
  recurringExpenses RecurringExpense[]
  
  // Invitations
  sentInvites     GroupInvite[] @relation("InviteSender")
  activities      Activity[]
  comments        Comment[]

  
  @@map("users")
}

// ============================================
// Groups
// ============================================

model Group {
  id          String   @id @default(cuid())
  name        String
  icon        String   @default("ðŸ‘¥")
  category    GroupCategory @default(OTHER)
  simplifyDebts Boolean @default(true)
  defaultCurrency String @default("INR")
  
  // Ephemeral/Trip mode fields
  isEphemeral          Boolean   @default(false)
  startDate            DateTime?
  endDate              DateTime?
  allowPreTripExpenses Boolean   @default(true)
  isArchived           Boolean   @default(false)
  archivedAt           DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  members     GroupMember[]
  expenses    Expense[]
  settlements Settlement[]
  invites     GroupInvite[]
  activities  Activity[]
  recurringExpenses RecurringExpense[]
  
  @@map("groups")
}


enum GroupCategory {
  TRIP
  HOME
  COUPLE
  FRIENDS
  WORK
  FAMILY
  STUDENT
  OFFICE
  CLUB
  DINING
  HOBBY
  OTHER
}

model GroupMember {
  id       String @id @default(cuid())
  userId   String
  groupId  String
  role     MemberRole @default(MEMBER)
  
  joinedAt DateTime @default(now())
  
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@unique([userId, groupId])
  @@map("group_members")
}

enum MemberRole {
  ADMIN
  MEMBER
}

// ============================================
// Invitations
// ============================================

model GroupInvite {
  id        String       @id @default(cuid())
  groupId   String
  email     String       // Email of invitee
  inviterId String       // Who sent the invite
  pseudoUserId String?   // If this invite is to claim a pseudo-user
  status    InviteStatus @default(PENDING)
  
  createdAt DateTime @default(now())
  expiresAt DateTime // 7 days from creation
  
  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  inviter User  @relation("InviteSender", fields: [inviterId], references: [id])
  
  @@unique([groupId, email])
  @@map("group_invites")
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

// ============================================
// Expenses
// ============================================

model Expense {
  id          String   @id @default(cuid())
  groupId     String
  paidById    String?  // Deprecated: kept for backwards compat, use payers instead
  
  description String
  amount      Int      // Amount in paise (smallest currency unit)
  currency    String   @default("INR")
  category    ExpenseCategory @default(OTHER)
  date        DateTime @default(now())
  notes       String?
  receiptUrl  String?
  
  splitType   SplitType @default(EQUAL)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  group  Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  paidBy User?  @relation("ExpensePayer", fields: [paidById], references: [id])
  payers ExpensePayer[]  // NEW: Multiple payers
  shares ExpenseShare[]
  comments Comment[]
  
  @@index([groupId, date])  // Optimize: sorted expense lists per group
  @@map("expenses")
}

// NEW: Support multiple payers per expense
model ExpensePayer {
  id        String @id @default(cuid())
  expenseId String
  userId    String
  
  amount    Int    // Amount this user paid (in paise)
  
  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([expenseId, userId])
  @@index([expenseId])  // Optimize: batch loading payers
  @@map("expense_payers")
}


enum ExpenseCategory {
  FOOD
  TRANSPORT
  ACCOMMODATION
  ENTERTAINMENT
  SHOPPING
  UTILITIES
  GROCERIES
  OTHER
}

enum SplitType {
  EQUAL
  EXACT
  PERCENTAGE
  SHARES
}

model ExpenseShare {
  id        String @id @default(cuid())
  expenseId String
  userId    String
  
  amount    Int    // Amount this user owes (in paise)
  
  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([expenseId, userId])
  @@index([expenseId])  // Optimize: batch loading shares
  @@index([userId])     // Optimize: balance calculations
  @@map("expense_shares")
}

// ============================================
// Settlements & Adjustments
// ============================================

model Settlement {
  id         String   @id @default(cuid())
  groupId    String
  payerId    String   // Person who paid
  receiverId String   // Person who received
  
  amount     Int      // Amount settled (in paise)
  currency   String   @default("INR")
  notes      String?
  type       SettlementType @default(PAYMENT)
  
  createdAt  DateTime @default(now())
  
  group    Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  payer    User  @relation("SettlementPayer", fields: [payerId], references: [id])
  receiver User  @relation("SettlementReceiver", fields: [receiverId], references: [id])
  
  @@index([groupId, createdAt])  // Optimize: settlement history queries
  @@map("settlements")
}

enum SettlementType {
  PAYMENT     // Actual money transfer
  ADJUSTMENT  // Manual balance adjustment
}

// ============================================
// Recurring Expenses
// ============================================

model RecurringExpense {
  id          String   @id @default(cuid())
  groupId     String
  createdById String
  
  description String
  amount      Int      // in paise
  currency    String   @default("INR")
  category    ExpenseCategory @default(OTHER)
  splitType   SplitType @default(EQUAL)
  
  // Schedule
  frequency   RecurrenceFrequency
  dayOfMonth  Int?     // 1-31 for MONTHLY
  dayOfWeek   Int?     // 0-6 for WEEKLY (0=Sunday)
  nextDueDate DateTime
  
  // Participants (stored as JSON for simplicity)
  participantIds String[] // User IDs involved
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  group     Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdBy User  @relation(fields: [createdById], references: [id])
  
  @@map("recurring_expenses")
}

enum RecurrenceFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  YEARLY
}

// ============================================
// Activity Log
// ============================================

model Activity {
  id          String       @id @default(cuid())
  groupId     String
  actorId     String
  type        ActivityType
  description String
  metadata    Json?        // Flexible storage for details (e.g. amount, expenseId)

  createdAt   DateTime     @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  actor User  @relation(fields: [actorId], references: [id])

  @@index([groupId, createdAt])  // Optimize: activity feed queries
  @@map("activities")
}

enum ActivityType {
  EXPENSE_CREATE
  EXPENSE_UPDATE
  EXPENSE_DELETE
  SETTLEMENT_CREATE
  SETTLEMENT_DELETE
  MEMBER_ADD
  MEMBER_REMOVE
  MEMBER_LEAVE
  GROUP_UPDATE
  INVITE_SEND
  INVITE_ACCEPT
  INVITE_DECLINE
  INVITE_CANCEL
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  expenseId String
  userId    String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  expense   Expense  @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("comments")
}
